#!/usr/bin/env node

var path = require('path');
var fs = require('fs');

var program = require('commander');
var yaml = require('yamljs');
var xtend = require('xtend');
var osenv = require('osenv');

var zuul = require('../lib/zuul');

program
.usage('[options] <files | dir>')
.option('--ui <mocha ui>', 'mocha ui for tests (bdd, tdd, qunit, export) [tdd]')
.option('--local [port]', 'port for manual testing in a local browser')
.parse(process.argv);

var config = {
    files: program.args,
    local: program.local,
    ui: program.ui
};

try {
    var cfg_file = path.join(process.cwd(), '.zuul.yml');
    var main_config = require(cfg_file);

    config = xtend(config, main_config);
} catch (err) {
    console.error('error loading %s config file', cfg_file);
    process.exit(1);
}

// optinal additional config from $HOME/.zuulrc
var home_config = path.join(osenv.home(), '.zuulrc');
if (fs.existsSync(home_config)) {
    var zuulrc = yaml.parse(fs.readFileSync(home_config, 'utf-8'));
    config = xtend(zuulrc, config);
}

var sauce_username = process.env.SAUCE_USERNAME;
var sauce_key = process.env.SAUCE_ACCESS_KEY;

config.username = sauce_username || config.sauce_username;
config.key = sauce_key || config.sauce_key;

zuul(config);

// vim: ft=javascript
