#!/usr/bin/env node

var path = require('path');

var program = require('commander');
var yaml = require('yamljs');
var xtend = require('xtend');

var zuul = require('../lib/zuul');

program
.usage('[options] <files | dir>')
.option('--ui <mocha ui>', 'mocha ui for tests (bdd, tdd, qunit, export) [tdd]')
.option('--local [port]', 'port for manual testing in a local browser')
.parse(process.argv);

var config = {
    files: program.args,
    local: program.local,
    ui: program.ui
};

// read config files
// main zuul.yml and possible env.yml

try {
    var cfg_file = path.join(process.cwd(), '.zuul.yml');
    var main_config = require(cfg_file);

    config = xtend(config, main_config);
} catch (err) {
    console.error('error loading %s config file', cfg_file);
    process.exit(1);
}

// optinal additional env config
try {
    var env_vars = require(path.join(process.cwd(), '.zuul.env.yml'));
    config = xtend(config, env_vars);
} catch (err) {} // ignored

var sauce_username = process.env.SAUCE_USERNAME;
var sauce_key = process.env.SAUCE_ACCESS_KEY;

config.username = config.username || sauce_username;
config.key = config.key || sauce_key;

zuul(config);

// vim: ft=javascript
